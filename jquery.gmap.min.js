/**
 * jQuery gMap v3
 *
 * @url         http://www.smashinglabs.pl/gmap
 * @author      Sebastian Poreba <sebastian.poreba@gmail.com>
 * @version     3.2.0 beta
 * @date        26.05.2011
 */
(function(i){var f=google.maps,m=new f.Geocoder,b={},n=0,g={},g={init:function(a){var d;b=i.extend({},i.fn.gMap.defaults,a);for(d in i.fn.gMap.defaults.icon)b.icon[d]||(b.icon[d]=i.fn.gMap.defaults.icon[d]);return this.each(function(){var a=i(this),d=g._getMapCenter.apply(a,[]),c,k,j,l=39135.758482;if(b.zoom=="fit"){c=g._getBoundaries();k=(c.E-c.W)*111E3/a.width();j=(c.S-c.N)*111E3/a.height();for(c=2;c<20;c+=1){if(k>l||j>l)break;l/=2}b.zoom=c-2}k=new f.Map(this,{zoom:b.zoom,center:d,mapTypeControl:b.mapTypeControl, zoomControl:b.zoomControl,panControl:b.panControl,scaleControl:b.scaleControl,streetViewControl:b.streetViewControl,mapTypeId:b.maptype,scrollwheel:b.scrollwheel});b.log&&console.log("map center is:");b.log&&console.log(d);a.data("$gmap",k);a.data("gmap",{opts:b,gmap:k,markers:[],markerKeys:{},infoWindow:null});if(b.controls.length!==0)for(c=0;c<b.controls.length;c+=1)k.controls[b.controls[c].pos].push(b.controls[c].div);if(b.markers.length!==0)for(c=0;c<b.markers.length;c+=1)g.addMarker.apply(a, [b.markers[c]]);g._onComplete.apply(a,[])})},_onComplete:function(){var a=this.data("gmap"),b=this;if(n!==0)window.setTimeout(function(){g._onComplete.apply(b,[])},1E3);else a.opts.onComplete()},_setMapCenter:function(a){b.log&&console.log("delayed setMapCenter called");var d=this.data("gmap");if(d.gmap!==void 0)d.gmap.setCenter(a);else{var e=this;window.setTimeout(function(){g._setMapCenter.apply(e,[a])},500)}},_boundaries:null,_getBoundaries:function(){if(g._boundaries)return g._boundaries;var a= b.markers[0].latitude,d=b.markers[0].longitude,e=b.markers[0].longitude,f=b.markers[0].latitude,c;for(c=1;c<b.markers.length;c+=1){if(a>b.markers[c].latitude)a=b.markers[c].latitude;if(d<b.markers[c].longitude)d=b.markers[c].longitude;if(e>b.markers[c].longitude)e=b.markers[c].longitude;if(f<b.markers[c].latitude)f=b.markers[c].latitude}g._boundaries={N:a,E:d,W:e,S:f};return g._boundaries},_getMapCenter:function(){var a,d=this,e,h;if(b.markers.length&&(b.latitude=="fit"||b.longitude=="fit"))return a= g._getBoundaries(),a=new f.LatLng((a.N+a.S)/2,(a.E+a.W)/2);if(b.latitude&&b.longitude)return a=new f.LatLng(b.latitude,b.longitude);else a=new f.LatLng(0,0);if(b.address)return m.geocode({address:b.address},function(a,e){e===google.maps.GeocoderStatus.OK?g._setMapCenter.apply(d,[a[0].geometry.location]):b.log&&console.log("Geocode was not successful for the following reason: "+e)}),a;if(b.markers.length>0){h=null;for(e=0;e<b.markers.length;e+=1)if(b.markers[e].setCenter){h=b.markers[e];break}if(h=== null)for(e=0;e<b.markers.length;e+=1){if(b.markers[e].latitude&&b.markers[e].longitude){h=b.markers[e];break}b.markers[e].address&&(h=b.markers[e])}if(h===null)return a;if(h.latitude&&h.longitude)return new f.LatLng(h.latitude,h.longitude);h.address&&m.geocode({address:h.address},function(a,e){e===google.maps.GeocoderStatus.OK?g._setMapCenter.apply(d,[a[0].geometry.location]):b.log&&console.log("Geocode was not successful for the following reason: "+e)})}return a},processMarker:function(a,d,e,g){var c= this.data("gmap"),k=c.gmap,j;g===void 0&&(g=new f.LatLng(a.latitude,a.longitude));if(!d)var l={image:b.icon.image,iconSize:new f.Size(b.icon.iconsize[0],b.icon.iconsize[1]),iconAnchor:new f.Point(b.icon.iconanchor[0],b.icon.iconanchor[1]),infoWindowAnchor:new f.Size(b.icon.infowindowanchor[0],b.icon.infowindowanchor[1])},d=new f.MarkerImage(l.image,l.iconSize,null,l.iconAnchor);e||(new f.Size(b.icon.shadowsize[0],b.icon.shadowsize[1]),l&&l.iconAnchor||new f.Point(b.icon.iconanchor[0],b.icon.iconanchor[1])); j=new f.Marker({position:g,icon:d,title:a.title,map:null});j.setShadow(e);c.markers.push(j);a.key&&(c.markerKeys[a.key]=j);var i;a.html&&(d={content:b.html_prepend+a.html+b.html_append,pixelOffset:a.infoWindowAnchor},b.log&&console.log("setup popup with data"),b.log&&console.log(d),i=new f.InfoWindow(d),f.event.addListener(j,"click",function(){b.log&&console.log("opening popup "+a.html);b.singleInfoWindow&&c.infoWindow&&c.infoWindow.close();i.open(k,j);c.infoWindow=i}));a.html&&a.popup&&(b.log&&console.log("opening popup "+ a.html),i.open(k,j))},_geocodeMarker:function(a,d){n+=1;var e=this;m.geocode({address:a.address},function(h,c){n-=1;c===f.GeocoderStatus.OK?g.processMarker.apply(e,[a,d,h[0].geometry.location]):b.log&&console.log("Geocode was not successful for the following reason: "+c)})},addMarker:function(a){b.log&&console.log("putting marker at "+a.latitude+", "+a.longitude+" with address "+a.address+" and html "+a.html);var d={image:b.icon.image,iconSize:new f.Size(b.icon.iconsize[0],b.icon.iconsize[1]),iconAnchor:new f.Point(b.icon.iconanchor[0], b.icon.iconanchor[1]),infoWindowAnchor:new f.Size(b.icon.infowindowanchor[0],b.icon.infowindowanchor[1])},e={image:b.icon.shadow,iconSize:new f.Size(b.icon.shadowsize[0],b.icon.shadowsize[1]),anchor:d.iconAnchor};a.infoWindowAnchor=d.infoWindowAnchor;if(a.icon){if(a.icon.image)d.image=a.icon.image;if(a.icon.iconsize)d.iconSize=new f.Size(a.icon.iconsize[0],a.icon.iconsize[1]);if(a.icon.iconanchor)d.iconAnchor=new f.Point(a.icon.iconanchor[0],a.icon.iconanchor[1]);if(a.icon.infowindowanchor)d.infoWindowAnchor= new f.Size(a.icon.infowindowanchor[0],a.icon.infowindowanchor[1]);if(a.icon.shadow)e.image=a.icon.shadow;if(a.icon.shadowsize)e.iconSize=new f.Size(a.icon.shadowsize[0],a.icon.shadowsize[1])}d=new f.MarkerImage(d.image,d.iconSize,null,d.iconAnchor);e=new f.MarkerImage(e.image,e.iconSize,null,e.anchor);if(a.address){if(a.html==="_address")a.html=a.address;if(a.title=="_address")a.title=a.address;b.log&&console.log("geocoding marker: "+a.address);g._geocodeMarker.apply(this,[a,d,e])}else{if(a.html=== "_latlng")a.html=a.latitude+", "+a.longitude;if(a.title=="_latlng")a.title=a.latitude+", "+a.longitude;var h=new f.LatLng(a.latitude,a.longitude);g.processMarker.apply(this,[a,d,e,h])}},removeAllMarkers:function(){var a=this.data("gmap").markers,b;for(b=0;b<a.length;b+=1)a[b].setMap(null)},getMarker:function(a){return this.data("gmap").markerKeys[a]}};i.fn.gMap=function(a){if(g[a])return g[a].apply(this,Array.prototype.slice.call(arguments,1));else if(typeof a==="object"||!a)return g.init.apply(this, arguments);else i.error("Method "+a+" does not exist on jQuery.gmap")};i.fn.gMap.defaults={log:!1,address:"",latitude:null,longitude:null,zoom:3,markers:[],controls:{},scrollwheel:!0,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,zoomControl:!0,panControl:!1,scaleControl:!1,streetViewControl:!0,singleInfoWindow:!0,html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png",iconsize:[20,34],iconanchor:[9,34],infowindowanchor:[9,2], shadow:"http://www.google.com/mapfiles/shadow50.png",shadowsize:[37,34]},onComplete:function(){}}})(jQuery);