/**
 * jQuery gMap v3
 *
 * @url         http://www.smashinglabs.pl/gmap
 * @author      Sebastian Poreba <sebastian.poreba@gmail.com>
 * @version     3.3.0 alpha
 * @date        26.05.2011
 */
(function(j){var m=function(){this.markers=[];this.mainMarker=!1};m.prototype.dist=function(a){return Math.sqrt(Math.pow(this.markers[0].getPosition().lat()-a.getPosition().lat(),2)+Math.pow(this.markers[0].getPosition().lng()-a.getPosition().lng(),2))};m.prototype.addMarker=function(a){this.markers.push(a)};m.prototype.getMarker=function(){if(this.mainmarker)return this.mainmarker;if(this.markers.length>1){var a=new g.MarkerImage("http://thydzik.com/thydzikGoogleMap/markerlink.php?text="+this.markers.length+ "&color=EF9D3F");return this.mainmarker=new g.Marker({position:this.markers[0].getPosition(),icon:a,title:"cluster of "+this.markers.length+" markers",map:null})}else return this.markers[0]};var g=google.maps,n=new g.Geocoder,b={},o=0,h={},h={init:function(a){var c;b=j.extend({},j.fn.gMap.defaults,a);for(c in j.fn.gMap.defaults.icon)b.icon[c]||(b.icon[c]=j.fn.gMap.defaults.icon[c]);return this.each(function(){var a=j(this),c=h._getMapCenter.apply(a,[]),e,l,i,k=39135.758482;if(b.zoom=="fit"){e=h._getBoundaries(); l=(e.E-e.W)*111E3/a.width();i=(e.S-e.N)*111E3/a.height();for(e=2;e<20;e+=1){if(l>k||i>k)break;k/=2}b.zoom=e-2}l=new g.Map(this,{zoom:b.zoom,center:c,mapTypeControl:b.mapTypeControl,zoomControl:b.zoomControl,panControl:b.panControl,scaleControl:b.scaleControl,streetViewControl:b.streetViewControl,mapTypeId:b.maptype,scrollwheel:b.scrollwheel});b.log&&console.log("map center is:");b.log&&console.log(c);a.data("$gmap",l);a.data("gmap",{opts:b,gmap:l,markers:[],markerKeys:{},infoWindow:null,clusters:[]}); if(b.controls.length!==0)for(e=0;e<b.controls.length;e+=1)l.controls[b.controls[e].pos].push(b.controls[e].div);if(b.markers.length!==0)for(e=0;e<b.markers.length;e+=1)h.addMarker.apply(a,[b.markers[e]]);b.clustering&&(h.renderCluster.apply(a,[]),g.event.addListener(l,"zoom_changed",function(){h.renderCluster.apply(a,[])}));h._onComplete.apply(a,[])})},_onComplete:function(){var a=this.data("gmap"),b=this;if(o!==0)window.setTimeout(function(){h._onComplete.apply(b,[])},1E3);else a.opts.onComplete()}, renderCluster:function(){var a=this.data("gmap"),c=a.markers,d=a.clusters,f,e;for(f=0;f<d.length;f+=1)d[f].getMarker().setMap(null);d.length=0;if(e=a.gmap.getBounds()){f=e.getNorthEast();var g=e.getSouthWest(),i=[],g=(f.lat()-g.lat())*b.clusterSize/100,k;for(f=0;f<c.length;f+=1)e.contains(c[f].getPosition())?i.push(c[f]):c[f].setMap(null);b.log&&console.log("number of markers "+i.length+"/"+c.length);b.log&&console.log("cluster radius: "+g);for(f=0;f<i.length;f+=1){e=-1;for(c=0;c<d.length;c+=1)if(k= d[c].dist(i[f]),k<g&&(e=c,b.fastClustering))break;e===-1?(c=new m,c.addMarker(i[f]),d.push(c)):d[e].addMarker(i[f])}b.log&&console.log("Total clusters in viewport: "+d.length);for(c=0;c<d.length;c+=1)d[c].getMarker().setMap(a.gmap)}else{var j=this;window.setTimeout(function(){h.renderCluster.apply(j)},1E3)}},_setMapCenter:function(a){b.log&&console.log("delayed setMapCenter called");var c=this.data("gmap");if(c.gmap!==void 0)c.gmap.setCenter(a);else{var d=this;window.setTimeout(function(){h._setMapCenter.apply(d, [a])},500)}},_boundaries:null,_getBoundaries:function(){if(h._boundaries)return h._boundaries;var a=b.markers[0].latitude,c=b.markers[0].longitude,d=b.markers[0].longitude,f=b.markers[0].latitude,e;for(e=1;e<b.markers.length;e+=1){if(a>b.markers[e].latitude)a=b.markers[e].latitude;if(c<b.markers[e].longitude)c=b.markers[e].longitude;if(d>b.markers[e].longitude)d=b.markers[e].longitude;if(f<b.markers[e].latitude)f=b.markers[e].latitude}h._boundaries={N:a,E:c,W:d,S:f};return h._boundaries},_getMapCenter:function(){var a, c=this,d,f;if(b.markers.length&&(b.latitude=="fit"||b.longitude=="fit"))return a=h._getBoundaries(),a=new g.LatLng((a.N+a.S)/2,(a.E+a.W)/2);if(b.latitude&&b.longitude)return a=new g.LatLng(b.latitude,b.longitude);else a=new g.LatLng(0,0);if(b.address)return n.geocode({address:b.address},function(a,d){d===google.maps.GeocoderStatus.OK?h._setMapCenter.apply(c,[a[0].geometry.location]):b.log&&console.log("Geocode was not successful for the following reason: "+d)}),a;if(b.markers.length>0){f=null;for(d= 0;d<b.markers.length;d+=1)if(b.markers[d].setCenter){f=b.markers[d];break}if(f===null)for(d=0;d<b.markers.length;d+=1){if(b.markers[d].latitude&&b.markers[d].longitude){f=b.markers[d];break}b.markers[d].address&&(f=b.markers[d])}if(f===null)return a;if(f.latitude&&f.longitude)return new g.LatLng(f.latitude,f.longitude);f.address&&n.geocode({address:f.address},function(a,d){d===google.maps.GeocoderStatus.OK?h._setMapCenter.apply(c,[a[0].geometry.location]):b.log&&console.log("Geocode was not successful for the following reason: "+ d)})}return a},processMarker:function(a,c,d,f){var e=this.data("gmap"),h=e.gmap,i;f===void 0&&(f=new g.LatLng(a.latitude,a.longitude));if(!c)var k={image:b.icon.image,iconSize:new g.Size(b.icon.iconsize[0],b.icon.iconsize[1]),iconAnchor:new g.Point(b.icon.iconanchor[0],b.icon.iconanchor[1]),infoWindowAnchor:new g.Size(b.icon.infowindowanchor[0],b.icon.infowindowanchor[1])},c=new g.MarkerImage(k.image,k.iconSize,null,k.iconAnchor);d||(new g.Size(b.icon.shadowsize[0],b.icon.shadowsize[1]),k&&k.iconAnchor|| new g.Point(b.icon.iconanchor[0],b.icon.iconanchor[1]));c={position:f,icon:c,title:a.title,map:null};if(!b.clustering)c.map=h;i=new g.Marker(c);i.setShadow(d);e.markers.push(i);a.key&&(e.markerKeys[a.key]=i);var j;a.html&&(d={content:b.html_prepend+a.html+b.html_append,pixelOffset:a.infoWindowAnchor},b.log&&console.log("setup popup with data"),b.log&&console.log(d),j=new g.InfoWindow(d),g.event.addListener(i,"click",function(){b.log&&console.log("opening popup "+a.html);b.singleInfoWindow&&e.infoWindow&& e.infoWindow.close();j.open(h,i);e.infoWindow=j}));a.html&&a.popup&&(b.log&&console.log("opening popup "+a.html),j.open(h,i))},_geocodeMarker:function(a,c){o+=1;var d=this;n.geocode({address:a.address},function(f,e){o-=1;e===g.GeocoderStatus.OK?h.processMarker.apply(d,[a,c,f[0].geometry.location]):b.log&&console.log("Geocode was not successful for the following reason: "+e)})},addMarker:function(a){b.log&&console.log("putting marker at "+a.latitude+", "+a.longitude+" with address "+a.address+" and html "+ a.html);var c={image:b.icon.image,iconSize:new g.Size(b.icon.iconsize[0],b.icon.iconsize[1]),iconAnchor:new g.Point(b.icon.iconanchor[0],b.icon.iconanchor[1]),infoWindowAnchor:new g.Size(b.icon.infowindowanchor[0],b.icon.infowindowanchor[1])},d={image:b.icon.shadow,iconSize:new g.Size(b.icon.shadowsize[0],b.icon.shadowsize[1]),anchor:c.iconAnchor};a.infoWindowAnchor=c.infoWindowAnchor;if(a.icon){if(a.icon.image)c.image=a.icon.image;if(a.icon.iconsize)c.iconSize=new g.Size(a.icon.iconsize[0],a.icon.iconsize[1]); if(a.icon.iconanchor)c.iconAnchor=new g.Point(a.icon.iconanchor[0],a.icon.iconanchor[1]);if(a.icon.infowindowanchor)c.infoWindowAnchor=new g.Size(a.icon.infowindowanchor[0],a.icon.infowindowanchor[1]);if(a.icon.shadow)d.image=a.icon.shadow;if(a.icon.shadowsize)d.iconSize=new g.Size(a.icon.shadowsize[0],a.icon.shadowsize[1])}c=new g.MarkerImage(c.image,c.iconSize,null,c.iconAnchor);d=new g.MarkerImage(d.image,d.iconSize,null,d.anchor);if(a.address){if(a.html==="_address")a.html=a.address;if(a.title== "_address")a.title=a.address;b.log&&console.log("geocoding marker: "+a.address);h._geocodeMarker.apply(this,[a,c,d])}else{if(a.html==="_latlng")a.html=a.latitude+", "+a.longitude;if(a.title=="_latlng")a.title=a.latitude+", "+a.longitude;var f=new g.LatLng(a.latitude,a.longitude);h.processMarker.apply(this,[a,c,d,f])}},removeAllMarkers:function(){var a=this.data("gmap").markers,b;for(b=0;b<a.length;b+=1)a[b].setMap(null)},getMarker:function(a){return this.data("gmap").markerKeys[a]}};j.fn.gMap=function(a){if(h[a])return h[a].apply(this, Array.prototype.slice.call(arguments,1));else if(typeof a==="object"||!a)return h.init.apply(this,arguments);else j.error("Method "+a+" does not exist on jQuery.gmap")};j.fn.gMap.defaults={log:!1,address:"",latitude:null,longitude:null,zoom:3,markers:[],controls:{},scrollwheel:!0,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,zoomControl:!0,panControl:!1,scaleControl:!1,streetViewControl:!0,singleInfoWindow:!0,html_prepend:'<div class="gmap_marker">',html_append:"</div>",icon:{image:"http://www.google.com/mapfiles/marker.png", iconsize:[20,34],iconanchor:[9,34],infowindowanchor:[9,2],shadow:"http://www.google.com/mapfiles/shadow50.png",shadowsize:[37,34]},onComplete:function(){},clustering:!1,fastClustering:!1,clusterCount:10,clusterSize:40}})(jQuery);